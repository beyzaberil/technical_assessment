name: UAV Assessment CI

# Bu iÅŸ akÄ±ÅŸÄ± ne zaman tetiklenecek?
# - main branch'ine bir push yapÄ±ldÄ±ÄŸÄ±nda
# - Manuel olarak "Run workflow" butonuna tÄ±klandÄ±ÄŸÄ±nda
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # 'test' adÄ±nda tek bir iÅŸimiz var
  test:
    # En gÃ¼ncel Ubuntu sunucusunda Ã§alÄ±ÅŸacak
    runs-on: ubuntu-latest
    name: Run Simulation Tests

    steps:
      # 1. AdÄ±m: AdayÄ±n kodunu sunucuya indirir
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. AdÄ±m: Docker'Ä± kurar ve hazÄ±rlar
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. AdÄ±m: Docker imajÄ±nÄ± oluÅŸturur
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true
          tags: uav-assessment-env:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 4. AdÄ±m: SimÃ¼lasyonu baÅŸlatÄ±r ve testleri Ã§alÄ±ÅŸtÄ±rÄ±r
      - name: Run Simulation and Tests
        id: task1
        continue-on-error: true
        run: |
          docker run --rm -t uav-assessment-env bash -c "
            # SimÃ¼lasyon bileÅŸenlerini arka planda baÅŸlat (&)
            echo 'Starting simulation components...'
            gzserver -s libgazebo_ros_init.so -s libgazebo_ros_factory.so &
            cd /root/PX4-Autopilot && export PX4_SIM_MODEL=standard_plane && build/px4_sitl_default/bin/px4 ROMFS/px4fmu_common -s etc/init.d-posix/rcS &
            micrortps_agent -t UDP &

            # Her ÅŸeyin baÅŸlamasÄ± iÃ§in 60 saniye bekle
            echo 'Waiting 60 seconds for simulation to initialize...'
            sleep 60

            # Åžimdi testi Ã§alÄ±ÅŸtÄ±r
            echo 'Running the test...'
            source /root/ros2_ws/install/setup.bash
            colcon test --packages-select test_package --ctest-args '-R test_task_1_arm_disarm'
          "

      # 5. AdÄ±m: DeÄŸerlendirme Raporunu OluÅŸturur
      - name: Generate Assessment Report
        if: always()
        run: |
          echo "## ðŸ“ Aday DeÄŸerlendirme Raporu" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ steps.task1.outcome }}" == "success" ]]; then
            echo "### âœ… GÃ¶rev 1: Arm ve Disarm BaÅŸarÄ±lÄ±" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ GÃ¶rev 1: Arm ve Disarm BaÅŸarÄ±sÄ±z" >> $GITHUB_STEP_SUMMARY
            echo "**Detaylar:** 'Run Simulation and Tests' adÄ±mÄ±nÄ±n loglarÄ±nÄ± inceleyin." >> $GITHUB_STEP_SUMMARY
          fi
