name: UAV Assessment CI

# Bu iş akışı ne zaman tetiklenecek?
# - main branch'ine bir push yapıldığında
# - Manuel olarak "Run workflow" butonuna tıklandığında
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # 'test' adında tek bir işimiz var
  test:
    # En güncel Ubuntu sunucusunda çalışacak
    runs-on: ubuntu-latest
    name: Run Simulation Tests

    steps:
      # 1. Adım: Adayın kodunu sunucuya indirir
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Adım: Docker'ı kurar ve hazırlar
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. Adım: Docker imajını oluşturur
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true
          tags: uav-assessment-env:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 4. Adım: Simülasyonu başlatır ve testleri çalıştırır
      - name: Run Simulation and Tests
        id: task1
        continue-on-error: true
        run: |
          docker run --rm -t uav-assessment-env bash -c "
            # Simülasyon bileşenlerini arka planda başlat (&)
            echo 'Starting simulation components...'
            gzserver -s libgazebo_ros_init.so -s libgazebo_ros_factory.so &
            cd /root/PX4-Autopilot && export PX4_SIM_MODEL=standard_plane && build/px4_sitl_default/bin/px4 ROMFS/px4fmu_common -s etc/init.d-posix/rcS &
            micrortps_agent -t UDP &

            # Her şeyin başlaması için 60 saniye bekle
            echo 'Waiting 60 seconds for simulation to initialize...'
            sleep 60

            # Şimdi testi çalıştır
            echo 'Running the test...'
            source /root/ros2_ws/install/setup.bash
            colcon test --packages-select test_package --ctest-args '-R test_task_1_arm_disarm'
          "

      # 5. Adım: Değerlendirme Raporunu Oluşturur
      - name: Generate Assessment Report
        if: always()
        run: |
          echo "## 📝 Aday Değerlendirme Raporu" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ steps.task1.outcome }}" == "success" ]]; then
            echo "### ✅ Görev 1: Arm ve Disarm Başarılı" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ❌ Görev 1: Arm ve Disarm Başarısız" >> $GITHUB_STEP_SUMMARY
            echo "**Detaylar:** 'Run Simulation and Tests' adımının loglarını inceleyin." >> $GITHUB_STEP_SUMMARY
          fi
